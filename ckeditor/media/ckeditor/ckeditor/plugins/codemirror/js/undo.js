function UndoHistory(a,d,b,f){this.container=a;this.maxDepth=d;this.commitDelay=b;this.editor=f;this.parent=f.parent;this.last=this.first=a={text:"",from:null,to:null};this.firstTouched=false;this.history=[];this.redoHistory=[];this.touched=[]}
UndoHistory.prototype={scheduleCommit:function(){var a=this;this.parent.clearTimeout(this.commitTimeout);this.commitTimeout=this.parent.setTimeout(function(){a.tryCommit()},this.commitDelay)},touch:function(a){this.setTouched(a);this.scheduleCommit()},undo:function(){this.commit();if(this.history.length){var a=this.history.pop();this.redoHistory.push(this.updateTo(a,"applyChain"));this.notifyEnvironment();return this.chainNode(a)}},redo:function(){this.commit();if(this.redoHistory.length){var a=this.redoHistory.pop();
this.addUndoLevel(this.updateTo(a,"applyChain"));this.notifyEnvironment();return this.chainNode(a)}},clear:function(){this.history=[];this.redoHistory=[]},historySize:function(){return{undo:this.history.length,redo:this.redoHistory.length}},push:function(a,d,b){for(var f=[],h=0;h<b.length;h++){var j=h==b.length-1?d:this.container.ownerDocument.createElement("BR");f.push({from:a,to:j,text:cleanText(b[h])});a=j}this.pushChains([f],a==null&&d==null);this.notifyEnvironment()},pushChains:function(a,d){this.commit(d);
this.addUndoLevel(this.updateTo(a,"applyChain"));this.redoHistory=[]},chainNode:function(a){for(var d=0;d<a.length;d++){var b=a[d][0];if(b=b&&(b.from||b.to))return b}},reset:function(){this.history=[];this.redoHistory=[]},textAfter:function(a){return this.after(a).text},nodeAfter:function(a){return this.after(a).to},nodeBefore:function(a){return this.before(a).from},tryCommit:function(){if(window.parent&&window.UndoHistory)this.editor.highlightDirty()?this.commit(true):this.scheduleCommit()},commit:function(a){this.parent.clearTimeout(this.commitTimeout);
a||this.editor.highlightDirty(true);a=this.touchedChains();if(a.length){this.addUndoLevel(this.updateTo(a,"linkChain"));this.redoHistory=[];this.notifyEnvironment()}},updateTo:function(a,d){for(var b=[],f=[],h=0;h<a.length;h++){b.push(this.shadowChain(a[h]));f.push(this[d](a[h]))}d=="applyChain"&&this.notifyDirty(f);return b},notifyDirty:function(a){forEach(a,method(this.editor,"addDirtyNode"));this.editor.scheduleHighlight()},notifyEnvironment:function(){this.onChange&&this.onChange();window.frameElement&&
window.frameElement.CodeMirror.updateNumbers&&window.frameElement.CodeMirror.updateNumbers()},linkChain:function(a){for(var d=0;d<a.length;d++){var b=a[d];if(b.from)b.from.historyAfter=b;else this.first=b;if(b.to)b.to.historyBefore=b;else this.last=b}},after:function(a){return a?a.historyAfter:this.first},before:function(a){return a?a.historyBefore:this.last},setTouched:function(a){if(a){if(!a.historyTouched){this.touched.push(a);a.historyTouched=true}}else this.firstTouched=true},addUndoLevel:function(a){this.history.push(a);
this.history.length>this.maxDepth&&this.history.shift()},touchedChains:function(){function a(e,g){if(e)e.historyTemp=g;else h=g}function d(e){for(var g=[],c=e?e.nextSibling:f.container.firstChild;c&&!isBR(c);c=c.nextSibling)c.currentText&&g.push(c.currentText);return{from:e,to:c,text:cleanText(g.join(""))}}function b(e,g){for(var c=g+"Sibling",i=e[c];i&&!isBR(i);)i=i[c];return i}var f=this,h=null,j=[];f.firstTouched&&f.touched.push(null);forEach(f.touched,function(e){if(!(e&&e.parentNode!=f.container)){if(e)e.historyTouched=
false;else f.firstTouched=false;var g=d(e),c=f.after(e);if(!c||c.text!=g.text||c.to!=g.to){j.push(g);a(e,g)}}});var k=[];f.touched=[];forEach(j,function(e){if(e.from?e.from.historyTemp:h){for(var g=[],c=e.from,i=true;;){var l=c?c.historyTemp:h;if(!l)if(i)break;else l=d(c);g.unshift(l);a(c,null);if(!c)break;i=f.after(c);c=b(c,"previous")}c=e.to;for(i=f.before(e.from);;){if(!c)break;l=c?c.historyTemp:h;if(!l)if(i)break;else l=d(c);g.push(l);a(c,null);i=f.before(c);c=b(c,"next")}k.push(g)}});return k},
shadowChain:function(a){var d=[],b=this.after(a[0].from);for(a=a[a.length-1].to;;){d.push(b);b=b.to;if(!b||b==a)break;else b=b.historyAfter||this.before(a)}return d},applyChain:function(a){var d=select.cursorPos(this.container,false),b=this,f=a[0].from,h=a[a.length-1].to;(function(i,l){for(var m=i?i.nextSibling:b.container.firstChild;m!=l;){var n=m.nextSibling;removeElement(m);m=n}})(f,h);for(var j=0;j<a.length;j++){var k=a[j];j>0&&b.container.insertBefore(k.from,h);var e=makePartSpan(fixSpaces(k.text),
this.container.ownerDocument);b.container.insertBefore(e,h);if(d&&d.node==k.from){e=0;var g=this.after(k.from);if(g&&j==a.length-1){for(var c=0;c<d.offset&&k.text.charAt(c)==g.text.charAt(c);c++);if(d.offset>c)e=k.text.length-g.text.length}select.setCursorPos(this.container,{node:k.from,offset:Math.max(0,d.offset+e)})}else d&&j==a.length-1&&d.node&&d.node.parentNode!=this.container&&select.setCursorPos(this.container,{node:k.from,offset:k.text.length})}this.linkChain(a);return f}};